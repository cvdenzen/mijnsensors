<?xml version="1.0" encoding="UTF-8"?>
<!--

autoonenabled wordt in principe hier bijgehouden en niet in Openhab.





-->
<blueprint xmlns="http://www.osgi.org/xmlns/blueprint/v1.0.0">

    <camelContext xmlns="http://camel.apache.org/schema/blueprint" id="blueprintcontext">

        <!-- hopeloos, te weinig documentatie om dit goed te krijgen -->
        <!-- route id="DefineCache" autoStartup="true" startupOrder="5">
		<from uri="ehcache://oh?configurationUri=file:${karaf.home}/etc/ehcache.xml"/>
		<from uri="ehcache://oh?configurationUri=classpath:etc/ehcache.xml"/>
		    <to uri="log:nl.vandenzen.pilightmqttosgi?level=INFO"/>
        </route -->

        <route id="HelloWorldFromBlueprint" autoStartup="true">
            <from uri="timer:simple?period=5000&amp;repeatCount=3"/>
            <setBody>
                <simple>Hello World from blueprint (Camel UPSPIco)</simple>
            </setBody>
            <to uri="log:nl.vandenzen.pilightmqttosgi?level=INFO"/>
            <to uri="log:vandenzen"/>
        </route>

        <route id="LichtIntensiteit_Woonkamer_updated" autoStartup="true" startupOrder="200">
            <from uri="paho:oh/LichtIntensiteit_Woonkamer/state"/>
            <to uri="log:nl.vandenzen.pilightmqttosgi?level=INFO"/>
            <convertBodyTo type="java.lang.String"/>
            <convertBodyTo type="java.lang.Float"/>
            <bean ref="LichtIntensiteit_Woonkamer" method="setValue"/>
            <to uri="direct:Enable_lights_on_by_daylight"/>
        </route>

        <route id="f0/nnw/pir_gf_achterdeur17_updated" autoStartup="true" startupOrder="201">
            <from uri="paho:oh/pir_gf_achterdeur17/state"/>
            <to uri="log:nl.vandenzen.pilightmqttosgi?level=INFO"/>
            <choice>
                <when>
                    <simple>${in.body} == "CLOSED"</simple>
                    <setBody>
                        <constant>PIR is CLOSED</constant>
                    </setBody>
                    <to uri="log:nl.vandenzen.pilightmqttosgi?level=INFO"/>
                    <bean ref="LightsOnIntensityThreshold" method="getValue"/>
                    <setHeader headerName="LightsOnIntensityThreshold">
                        <simple>${in.body}</simple>
                    </setHeader>
                    <bean ref="LichtIntensiteit_Woonkamer" method="getValue"/>
                    <setBody>
                        <simple>het is donker, ${in.body} moet kleiner zijn dan ${header.LightsOnIntensityThreshold}
                        </simple>
                    </setBody>
                    <bean ref="LichtIntensiteit_Woonkamer" method="getValue"/>
                    <to uri="log:nl.vandenzen.pilightmqttosgi?level=INFO"/>
                    <choice>
                        <when>
                            <simple>${in.body} &lt; ${header.LightsOnIntensityThreshold}</simple>
                            <!-- lichten aan als hij uit staat -->
                            <setBody>
                                <simple>het is donker</simple>
                            </setBody>
                            <to uri="log:nl.vandenzen.pilightmqttosgi?level=INFO"/>
                            <bean ref="Light_GF_Huiskamer_Achterdeur_Schemerlamp" method="getValue"/>
                            <!-- make light state (on or off) available to delay-bean -->
                            <bean ref="DelayHuiskamerAchterdeurSchemerlamp" method="setLightState"/>
                            <choice>
                                <when>
                                    <simple>${in.body} == "false"</simple>
                                    <setBody>
                                        <simple>het licht is uit</simple>
                                    </setBody>
                                    <to uri="log:nl.vandenzen.pilightmqttosgi?level=INFO"/>
                                    <to uri="direct:Light_GF_Huiskamer_Achterdeur_Schemerlamp_aan"/>
                                </when>
                            </choice>
                            <!-- delay -->
                            <bean ref="GF_Passenger_minutes" method="getMilliSeconds"/>
                            <convertBodyTo type="java.lang.String"/>
                            <convertBodyTo type="java.lang.Long"/>
                            <bean ref="DelayHuiskamerAchterdeurSchemerlamp" method="setDelay"/>
                            <bean ref="DelayHuiskamerAchterdeurSchemerlamp" method="restartTimer"/>
                        </when>
                    </choice>
                </when>
            </choice>
        </route>

        <route id="listenAutoOnEnabled" autoStartup="true" startupOrder="202">
            <from uri="paho:oh/AutoOnEnabled/state"/>
            <convertBodyTo type="java.lang.String"/>
            <choice>
                <when>
                    <simple>${in.body} == "1"</simple>
                    <setBody>
                        <constant>true</constant>
                    </setBody>
                </when>
                <otherwise>
                    <setBody>
                        <constant>false</constant>
                    </setBody>
                </otherwise>
            </choice>
            <convertBodyTo type="java.lang.Boolean"/>
            <bean ref="AutoOnEnabled" method="setValue"/>
            <!-- Turn on lights? -->
            <to uri="direct:Enable_lights_on_by_daylight"/>
        </route>
        <route id="listenLightsOnIntensityThreshold" autoStartup="true" startupOrder="203">
            <from uri="paho:oh/LightsOnIntensityThreshold/state"/>
            <to uri="log:nl.vandenzen.pilightmqttosgi?level=INFO"/>
            <convertBodyTo type="java.lang.String"/>
            <to uri="log:nl.vandenzen.pilightmqttosgi?level=INFO"/>
            <convertBodyTo type="java.lang.Integer"/>
            <to uri="log:nl.vandenzen.pilightmqttosgi?level=INFO"/>
            <bean ref="LightsOnIntensityThreshold" method="setValue"/>
            <!-- Turn on lights? -->
            <to uri="direct:Enable_lights_on_by_daylight"/>
        </route>
        <route id="listenLight_GF_Huiskamer_Achterdeur_Schemerlamp" autoStartup="true" startupOrder="204">
            <from uri="paho:oh/Light_GF_Huiskamer_Achterdeur_Schemerlamp/state"/>
            <choice>
                <when>
                    <simple>${in.body} == "ON"</simple>
                    <setBody>
                        <constant>true</constant>
                    </setBody>
                </when>
                <otherwise>
                    <setBody>
                        <constant>false</constant>
                    </setBody>
                </otherwise>
            </choice>
            <bean ref="Light_GF_Huiskamer_Achterdeur_Schemerlamp" method="setValue"/>
        </route>
        <route id="listenGF_Passenger_minutes" autoStartup="true" startupOrder="205">
            <from uri="paho:oh/GF_Passenger_minutes/state"/>
            <convertBodyTo type="java.lang.String"/>
            <convertBodyTo type="java.lang.Integer"/>
            <bean ref="GF_Passenger_minutes" method="setValue"/>
        </route>
        <route id="listen_bg_w_tv_w" autoStartup="true" startupOrder="206">
            <from uri="paho:oh/bg_w_tv_w/state"/>
            <choice>
                <when>
                    <simple>${in.body} == "ON"</simple>
                    <setBody>
                        <constant>true</constant>
                    </setBody>
                </when>
                <otherwise>
                    <setBody>
                        <constant>false</constant>
                    </setBody>
                </otherwise>
            </choice>
            <bean ref="bg_w_tv_w" method="setValue"/>
            <!-- check whether to turn lights off -->
            <to uri="direct:LightsOffCalc"/>
        </route>

        <route id="listenbg_x_imac3" autoStartup="true" startupOrder="207">
            <from uri="paho:oh/bg_x_imac3/state"/>
            <choice>
                <when>
                    <simple>${in.body} == "ON"</simple>
                    <setBody>
                        <constant>true</constant>
                    </setBody>
                </when>
                <otherwise>
                    <setBody>
                        <constant>false</constant>
                    </setBody>
                </otherwise>
            </choice>
            <bean ref="bg_x_imac3" method="setValue"/>
            <!-- check whether to turn lights off -->
            <to uri="direct:LightsOffCalc"/>
        </route>

        <!-- Zet lichten aan -->
        <route id="ZetLichtenAan" autoStartup="true" startupOrder="101">
            <from uri="direct:ZetLichtenAan"/>
            <setBody>
                <simple>Lichten gaan aan!</simple>
            </setBody>
            <to uri="log:nl.vandenzen.pilightmqttosgi?level=INFO"/>
            <setBody>
                <constant>on</constant>
            </setBody>
            <to uri="paho:f0/kaku_switch_old/cmd/3/0"/>
            <to uri="paho:f0/kaku_switch_old/cmd/3/1"/>
        </route>

        <!-- Zet lichten uit -->
        <route id="ZetLichtenUit" autoStartup="true" startupOrder="102">
            <from uri="direct:ZetLichtenUit"/>
            <setBody>
                <constant>off</constant>
            </setBody>
            <to uri="paho:f0/kaku_switch_old/cmd/3/0"/>
            <to uri="paho:f0/kaku_switch_old/cmd/3/1"/>
        </route>

        <!-- Zet 1 licht aan -->
        <route id="Light_GF_Huiskamer_Achterdeur_Schemerlamp_aan" autoStartup="true" startupOrder="103">
            <from uri="direct:Light_GF_Huiskamer_Achterdeur_Schemerlamp_aan"/>
            <setBody>
                <constant>on</constant>
            </setBody>
            <to uri="paho:f0/kaku_switch_old/cmd/3/0"/>
        </route>
        <!-- Zet 1 licht uit -->
        <route id="Light_GF_Huiskamer_Achterdeur_Schemerlamp_uit" autoStartup="true" startupOrder="104">
            <from uri="direct:Light_GF_Huiskamer_Achterdeur_Schemerlamp_uit"/>
            <setBody>
                <constant>off</constant>
            </setBody>
            <to uri="paho:f0/kaku_switch_old/cmd/3/0"/>
        </route>
        <!-- Zet 1 licht aan -->
        <route id="Light_GF_Huiskamer_Achter_Staandelamp_aan" autoStartup="true" startupOrder="105">
            <from uri="direct:Light_GF_Huiskamer_Achter_Staandelamp_aan"/>
            <setBody>
                <constant>on</constant>
            </setBody>
            <to uri="paho:f0/kaku_switch_old/cmd/3/1"/>
        </route>
        <!-- Zet 1 licht uit -->
        <route id="Light_GF_Huiskamer_Achter_Staandelamp_uit" autoStartup="true" startupOrder="106">
            <from uri="direct:Light_GF_Huiskamer_Achter_Staandelamp_uit"/>
            <setBody>
                <constant>off</constant>
            </setBody>
            <to uri="paho:f0/kaku_switch_old/cmd/3/1"/>
        </route>
        <route id="AutoOnEnabled_aan" autoStartup="true" startupOrder="301">
            <!-- s m h day-of-month month day-of-week year(optional) -->
            <from uri="quartz2://groep/timer1?cron=0+0+12+*+*+?"/>
            <setBody>
                <constant>true</constant>
            </setBody>
            <bean ref="AutoOnEnabled" method="setValue"/>
        </route>
        <route id="AutoOffEnabled_aan" autoStartup="true" startupOrder="302">
            <!-- s m h day-of-month month day-of-week year(optional) -->
            <from uri="quartz2://groep/timer2?cron=47+50+22+*+*+?"/>
            <setBody>
                <constant>true</constant>
            </setBody>
            <bean ref="AutoOffEnabled" method="setValue"/>
            <!-- check whether to turn lights off -->
            <to uri="direct:LightsOffCalc"/>
        </route>


        <!-- Generic entry point for turning on the lights automatically based on light settings -->
        <route id="direct:Enable_lights_on_by_daylight" autoStartup="true" startupOrder="401">
            <from uri="direct:Enable_lights_on_by_daylight"/>
            <to uri="log:nl.vandenzen.pilightmqttosgi?level=INFO"/>
            <bean ref="LichtIntensiteit_Woonkamer" method="getValue"/>
            <to uri="direct:SetHeaders"/>
            <choice>
                <when>
                    <javaScript>
                        request.headers.get('AutoOnEnabled')
                        &amp;&amp;
                        // it is dark
                        request.headers.get('LichtIntensiteit_Woonkamer') &lt;
                        request.headers.get('LightsOnIntensityThreshold')
                    </javaScript>
                    <setBody>
                        <simple>Licht gaat aan!</simple>
                    </setBody>
                    <to uri="log:nl.vandenzen.pilightmqttosgi?level=INFO"/>
                    <to uri="direct:ZetLichtenAan"/>
                    <!-- disable automatic turning on the lights -->
                    <setBody>
                        <constant>false</constant>
                    </setBody>
                    <bean ref="AutoOnEnabled" method="setValue"/>
                </when>
            </choice>
        </route>
        <!-- Generic entry point for turning off the lights automatically based on light settings -->
        <route id="LightsOffCalc" autoStartup="true" startupOrder="402">
            <from uri="direct:LightsOffCalc"/>
            <to uri="direct:SetHeaders"/>
            <choice>
                <when>
                    <javaScript>
                        request.headers.get('AutoOffEnabled')
                        &amp;&amp;
                        !request.headers.get('bg_w_tv_w') // tv is off
                        &amp;&amp;
                        !request.headers.get('bg_x_imac3') // and imac is off
                    </javaScript>
                    <setBody>
                        <simple>Licht gaat uit.</simple>
                    </setBody>
                    <to uri="log:nl.vandenzen.pilightmqttosgi?level=INFO"/>
                    <!-- staande lamp direct uitzetten, achterdeurlamp pas na een delay -->
                    <to uri="direct:Light_GF_Huiskamer_Achter_Staandelamp_uit"/>
                    <!-- disable automatic turning off the lights -->
                    <setBody>
                        <constant>false</constant>
                    </setBody>
                    <bean ref="AutoOffEnabled" method="setValue"/>
                    <!-- delay for only one light (achterdeur)-->
                    <bean ref="GF_Passenger_minutes" method="getMilliSeconds"/>
                    <convertBodyTo type="java.lang.String"/>
                    <convertBodyTo type="java.lang.Long"/>
                    <bean ref="DelayHuiskamerAchterdeurSchemerlamp" method="setDelay"/>
                    <bean ref="DelayHuiskamerAchterdeurSchemerlamp" method="restartTimer"/>
                </when>
            </choice>
        </route>
        <route id="SetHeaders" autoStartup="true" startupOrder="501">
            <from uri="direct:SetHeaders"/>
            <setHeader headerName="LichtIntensiteit_Woonkamer">
                <method ref="LichtIntensiteit_Woonkamer" method="getValue"/>
            </setHeader>
            <setHeader headerName="LightsOnIntensityThreshold">
                <method ref="LightsOnIntensityThreshold" method="getValue"/>
            </setHeader>
            <setHeader headerName="AutoOnEnabled">
                <method ref="AutoOnEnabled" method="getValue"/>
            </setHeader>
            <setHeader headerName="AutoOffEnabled">
                <method ref="AutoOffEnabled" method="getValue"/>
            </setHeader>
            <setHeader headerName="bg_w_tv_w">
                <method ref="bg_w_tv_w" method="getValue"/>
            </setHeader>
            <setHeader headerName="bg_x_imac3">
                <method ref="bg_x_imac3" method="getValue"/>
            </setHeader>
        </route>

    </camelContext>
    <!-- bean id="autoOnEnabled" class="java.util.concurrent.atomic.AtomicReference"/ -->
    <bean id="AutoOnEnabled" class="nl.vandenzen.pilightmqttosgi.util.MutableBoolean"/>
    <bean id="AutoOffEnabled" class="nl.vandenzen.pilightmqttosgi.util.MutableBoolean"/>
    <bean id="LightsOnIntensityThreshold" class="nl.vandenzen.pilightmqttosgi.util.MutableInteger">
        <property name="value" value="4"/>
    </bean>
    <bean id="LightsEnableIntensityThreshold" class="nl.vandenzen.pilightmqttosgi.util.MutableInteger">
        <property name="value" value="31"/>
    </bean>
    <bean id="LichtIntensiteit_Woonkamer" class="nl.vandenzen.pilightmqttosgi.util.MutableFloat">
        <property name="value" value="50"/>
    </bean>
    <bean id="Light_GF_Huiskamer_Achterdeur_Schemerlamp" class="nl.vandenzen.pilightmqttosgi.util.MutableBoolean"/>
    <bean id="Light_GF_Huiskamer_Achter_Staandelamp" class="nl.vandenzen.pilightmqttosgi.util.MutableBoolean"/>
    <bean id="GF_Passenger_minutes" class="nl.vandenzen.pilightmqttosgi.util.MutableLong">
        <property name="value" value="1"/>
    </bean>


    <bean id="bg_w_tv_w" class="nl.vandenzen.pilightmqttosgi.util.MutableBoolean"/>
    <bean id="bg_x_imac3" class="nl.vandenzen.pilightmqttosgi.util.MutableBoolean"/>
    <bean id="DelayHuiskamerAchterdeurSchemerlamp" class="nl.vandenzen.pilightmqttosgi.beans.ExtendableDelay">
        <!-- The uri to call when delay has finished -->
        <argument value="direct:Light_GF_Huiskamer_Achterdeur_Schemerlamp_uit"/>
    </bean>

</blueprint>